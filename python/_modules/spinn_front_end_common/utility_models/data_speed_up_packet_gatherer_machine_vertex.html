<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>spinn_front_end_common.utility_models.data_speed_up_packet_gatherer_machine_vertex &#8212; SpiNNFrontEndCommon  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SpiNNFrontEndCommon  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spinn_front_end_common.utility_models.data_speed_up_packet_gatherer_machine_vertex</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2017-2019 The University of Manchester</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">xrange</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">reraise</span><span class="p">,</span> <span class="n">PY2</span>
<span class="kn">from</span> <span class="nn">spinn_utilities.overrides</span> <span class="kn">import</span> <span class="n">overrides</span>
<span class="kn">from</span> <span class="nn">spinn_utilities.log</span> <span class="kn">import</span> <span class="n">FormatAdapter</span>
<span class="kn">from</span> <span class="nn">spinnman.exceptions</span> <span class="kn">import</span> <span class="n">SpinnmanTimeoutException</span>
<span class="kn">from</span> <span class="nn">spinnman.messages.sdp</span> <span class="kn">import</span> <span class="n">SDPMessage</span><span class="p">,</span> <span class="n">SDPHeader</span><span class="p">,</span> <span class="n">SDPFlag</span>
<span class="kn">from</span> <span class="nn">spinnman.messages.scp.impl.iptag_set</span> <span class="kn">import</span> <span class="n">IPTagSet</span>
<span class="kn">from</span> <span class="nn">spinnman.connections.udp_packet_connections</span> <span class="kn">import</span> <span class="n">SCAMPConnection</span>
<span class="kn">from</span> <span class="nn">spinnman.model.enums.cpu_state</span> <span class="kn">import</span> <span class="n">CPUState</span>
<span class="kn">from</span> <span class="nn">pacman.executor.injection_decorator</span> <span class="kn">import</span> <span class="n">inject_items</span>
<span class="kn">from</span> <span class="nn">pacman.model.graphs.common</span> <span class="kn">import</span> <span class="n">EdgeTrafficType</span>
<span class="kn">from</span> <span class="nn">pacman.model.graphs.machine</span> <span class="kn">import</span> <span class="n">MachineVertex</span>
<span class="kn">from</span> <span class="nn">pacman.model.resources</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ConstantSDRAM</span><span class="p">,</span> <span class="n">IPtagResource</span><span class="p">,</span> <span class="n">ResourceContainer</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">spinn_storage_handlers</span> <span class="kn">import</span> <span class="n">FileDataReader</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.utilities.globals_variables</span> <span class="kn">import</span> <span class="n">get_simulator</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.utilities.helpful_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">convert_vertices_to_core_subset</span><span class="p">,</span> <span class="n">emergency_recover_state_from_failure</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.abstract_models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AbstractHasAssociatedBinary</span><span class="p">,</span> <span class="n">AbstractGeneratesDataSpecification</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.interface.provenance</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AbstractProvidesLocalProvenanceData</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.utilities.utility_objs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExecutableType</span><span class="p">,</span> <span class="n">ProvenanceDataItem</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.utilities.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SDP_PORTS</span><span class="p">,</span> <span class="n">BYTES_PER_WORD</span><span class="p">,</span> <span class="n">BYTES_PER_KB</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.utilities.exceptions</span> <span class="kn">import</span> <span class="n">SpinnFrontEndException</span>
<span class="kn">from</span> <span class="nn">spinn_front_end_common.utilities.utility_objs.</span>\
    <span class="n">extra_monitor_scp_processes</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">SetRouterTimeoutProcess</span><span class="p">,</span> <span class="n">SetRouterEmergencyTimeoutProcess</span><span class="p">,</span>
        <span class="n">ClearQueueProcess</span><span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">FormatAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>

<span class="c1"># shift by for the destination x coord in the word.</span>
<span class="n">DEST_X_SHIFT</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">TIMEOUT_RETRY_LIMIT</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">TIMEOUT_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;Failed to hear from the machine during </span><span class="si">{}</span><span class="s2"> attempts. &quot;</span>\
    <span class="s2">&quot;Please try removing firewalls.&quot;</span>
<span class="n">_MINOR_LOSS_MESSAGE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;During the extraction of data of </span><span class="si">{}</span><span class="s2"> bytes from memory address </span><span class="si">{}</span><span class="s2">, &quot;</span>
    <span class="s2">&quot;attempt </span><span class="si">{}</span><span class="s2"> had </span><span class="si">{}</span><span class="s2"> sequences that were lost.&quot;</span><span class="p">)</span>
<span class="n">_MINOR_LOSS_THRESHOLD</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">_MAJOR_LOSS_MESSAGE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;During the extraction of data from chip </span><span class="si">{}</span><span class="s2">, there were </span><span class="si">{}</span><span class="s2"> cases of &quot;</span>
    <span class="s2">&quot;serious data loss. The system recovered, but the speed of download &quot;</span>
    <span class="s2">&quot;was compromised. Reduce the number of executing applications and remove &quot;</span>
    <span class="s2">&quot;routers between yourself and the SpiNNaker machine to reduce the chance &quot;</span>
    <span class="s2">&quot;of this occurring.&quot;</span><span class="p">)</span>
<span class="n">_MAJOR_LOSS_THRESHOLD</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># cap for stopping wrap arounds</span>
<span class="n">TRANSACTION_ID_CAP</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>

<span class="c1">#: number of items used up by the retransmit code for its header</span>
<span class="n">SDP_RETRANSMISSION_HEADER_SIZE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1">#: size of config region in bytes</span>
<span class="c1">#: 1.new seq key, 2.first data key, 3. transaction id key 4.end flag key,</span>
<span class="c1"># 5.base key, 6.iptag tag</span>
<span class="n">CONFIG_SIZE</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span>

<span class="c1">#: items of data a SDP packet can hold when SCP header removed</span>
<span class="n">WORDS_PER_FULL_PACKET</span> <span class="o">=</span> <span class="mi">68</span>  <span class="c1"># 272 bytes as removed SCP header</span>

<span class="c1">#: size of items the sequence number uses</span>
<span class="n">SEQUENCE_NUMBER_SIZE_IN_ITEMS</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">#: transaction id size in words</span>
<span class="n">TRANSACTION_ID_SIZE_IN_ITEMS</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">#: the size in words of the command flag</span>
<span class="n">COMMAND_SIZE_IN_ITEMS</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">#: offset for missing seq starts in first packet</span>
<span class="n">WORDS_FOR_COMMAND_N_MISSING_TRANSACTION</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1">#: offset for missing seq starts in more packet</span>
<span class="n">WORDS_FOR_COMMAND_TRANSACTION</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">COMMAND_SIZE_IN_ITEMS</span> <span class="o">+</span> <span class="n">TRANSACTION_ID_SIZE_IN_ITEMS</span><span class="p">)</span>

<span class="n">BYTES_FOR_SEQ_AND_TRANSACTION_ID</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">SEQUENCE_NUMBER_SIZE_IN_ITEMS</span> <span class="o">+</span> <span class="n">TRANSACTION_ID_SIZE_IN_ITEMS</span><span class="p">)</span> <span class="o">*</span>
    <span class="n">BYTES_PER_WORD</span><span class="p">)</span>

<span class="c1">#: items of data from SDP packet with a sequence number</span>
<span class="n">WORDS_PER_FULL_PACKET_WITH_SEQUENCE_NUM</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">WORDS_PER_FULL_PACKET</span> <span class="o">-</span> <span class="n">SEQUENCE_NUMBER_SIZE_IN_ITEMS</span> <span class="o">-</span>
    <span class="n">TRANSACTION_ID_SIZE_IN_ITEMS</span><span class="p">)</span>

<span class="c1">#: offset where data in starts on commands</span>
<span class="c1">#: (command, transaction_id, seq num)</span>
<span class="n">WORDS_FOR_COMMAND_AND_KEY</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">BYTES_FOR_COMMAND_AND_ADDRESS_HEADER</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">WORDS_FOR_COMMAND_AND_KEY</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span>

<span class="c1">#: offset where data in starts in reception (command, transaction id)</span>
<span class="n">WORDS_FOR_RECEPTION_COMMAND_AND_ADDRESS_HEADER</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">BYTES_FOR_RECEPTION_COMMAND_AND_ADDRESS_HEADER</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">WORDS_FOR_RECEPTION_COMMAND_AND_ADDRESS_HEADER</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span>

<span class="c1">#: size for data to store when first packet with command and address</span>
<span class="n">WORDS_IN_FULL_PACKET_WITH_KEY</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">WORDS_PER_FULL_PACKET</span> <span class="o">-</span> <span class="n">WORDS_FOR_COMMAND_AND_KEY</span><span class="p">)</span>
<span class="n">BYTES_IN_FULL_PACKET_WITH_KEY</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">WORDS_IN_FULL_PACKET_WITH_KEY</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span>

<span class="c1">#: size of data in key space</span>
<span class="c1">#: x, y, key (all ints) for possible 48 chips, plus n chips to read,</span>
<span class="c1"># the reinjector base key.</span>
<span class="n">SIZE_DATA_IN_CHIP_TO_KEY_SPACE</span> <span class="o">=</span> <span class="p">((</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">48</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span>


<span class="k">class</span> <span class="nc">_DATA_REGIONS</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DSG data regions&quot;&quot;&quot;</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">CHIP_TO_KEY_SPACE</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">DATA_OUT_COMMANDS</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;command IDs for the SDP packets for data out&quot;&quot;&quot;</span>
    <span class="n">START_SENDING</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">START_MISSING_SEQ</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">MISSING_SEQ</span> <span class="o">=</span> <span class="mi">1001</span>
    <span class="n">CLEAR</span> <span class="o">=</span> <span class="mi">2000</span>


<span class="k">class</span> <span class="nc">DATA_IN_COMMANDS</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;command IDs for the SDP packets for data in&quot;&quot;&quot;</span>
    <span class="n">SEND_DATA_TO_LOCATION</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">SEND_SEQ_DATA</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">SEND_TELL</span> <span class="o">=</span> <span class="mi">2001</span>
    <span class="n">RECEIVE_MISSING_SEQ_DATA</span> <span class="o">=</span> <span class="mi">2002</span>
    <span class="n">RECEIVE_FINISHED</span> <span class="o">=</span> <span class="mi">2003</span>


<span class="c1"># precompiled structures</span>
<span class="n">_ONE_WORD</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">)</span>
<span class="n">_TWO_WORDS</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;&lt;II&quot;</span><span class="p">)</span>
<span class="n">_THREE_WORDS</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;&lt;III&quot;</span><span class="p">)</span>
<span class="n">_FOUR_WORDS</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;&lt;IIII&quot;</span><span class="p">)</span>
<span class="n">_FIVE_WORDS</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;&lt;IIIII&quot;</span><span class="p">)</span>

<span class="c1"># Set to true to check that the data is correct after it has been sent in.</span>
<span class="c1"># This is expensive, and only works in Python 3.5 or later.</span>
<span class="n">VERIFY_SENT_DATA</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">ceildiv</span><span class="p">(</span><span class="n">dividend</span><span class="p">,</span> <span class="n">divisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; How to divide two possibly-integer numbers and round up.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">divisor</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">dividend</span><span class="p">,</span> <span class="n">divisor</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>


<span class="c1"># SDRAM requirement for storing missing SDP packets seq nums</span>
<span class="n">SDRAM_FOR_MISSING_SDP_SEQ_NUMS</span> <span class="o">=</span> <span class="n">ceildiv</span><span class="p">(</span>
    <span class="mf">120.0</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">BYTES_PER_KB</span><span class="p">,</span>
    <span class="n">WORDS_PER_FULL_PACKET_WITH_SEQUENCE_NUM</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span>


<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex">[docs]</a><span class="k">class</span> <span class="nc">DataSpeedUpPacketGatherMachineVertex</span><span class="p">(</span>
        <span class="n">MachineVertex</span><span class="p">,</span> <span class="n">AbstractGeneratesDataSpecification</span><span class="p">,</span>
        <span class="n">AbstractHasAssociatedBinary</span><span class="p">,</span> <span class="n">AbstractProvidesLocalProvenanceData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Machine vertex for handling fast data transfer between host and \</span>
<span class="sd">        SpiNNaker. This machine vertex is only ever placed on chips with a \</span>
<span class="sd">        working Ethernet connection; it collaborates with the \</span>
<span class="sd">        :py:class:`ExtraMonitorSupportMachineVertex` to write data on other \</span>
<span class="sd">        chips..</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># x coordinate</span>
        <span class="s2">&quot;_x&quot;</span><span class="p">,</span>
        <span class="c1"># y coordinate</span>
        <span class="s2">&quot;_y&quot;</span><span class="p">,</span>
        <span class="c1"># word with x and y</span>
        <span class="s2">&quot;_coord_word&quot;</span><span class="p">,</span>
        <span class="c1"># transaction id</span>
        <span class="s2">&quot;_transaction_id&quot;</span><span class="p">,</span>
        <span class="c1"># app id</span>
        <span class="s2">&quot;_app_id&quot;</span><span class="p">,</span>
        <span class="c1"># socket</span>
        <span class="s2">&quot;_connection&quot;</span><span class="p">,</span>
        <span class="c1"># store of the extra monitors to location. helpful in data in</span>
        <span class="s2">&quot;_extra_monitors_by_chip&quot;</span><span class="p">,</span>
        <span class="c1"># path for the data in report</span>
        <span class="s2">&quot;_in_report_path&quot;</span><span class="p">,</span>
        <span class="c1"># ipaddress</span>
        <span class="s2">&quot;_ip_address&quot;</span><span class="p">,</span>
        <span class="c1"># store for the last reinjection status</span>
        <span class="s2">&quot;_last_status&quot;</span><span class="p">,</span>
        <span class="c1"># the max seq num expected given a data retrieval</span>
        <span class="s2">&quot;_max_seq_num&quot;</span><span class="p">,</span>
        <span class="c1"># holder for missing seq nums for data in</span>
        <span class="s2">&quot;_missing_seq_nums_data_in&quot;</span><span class="p">,</span>
        <span class="c1"># holder of data from out</span>
        <span class="s2">&quot;_output&quot;</span><span class="p">,</span>
        <span class="c1"># my placement for future lookup</span>
        <span class="s2">&quot;_placement&quot;</span><span class="p">,</span>
        <span class="c1"># provenance holder</span>
        <span class="s2">&quot;_provenance_data_items&quot;</span><span class="p">,</span>
        <span class="c1"># Count of the runs for provenance data</span>
        <span class="s2">&quot;_run&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_remote_tag&quot;</span><span class="p">,</span>
        <span class="c1"># path to the data out report</span>
        <span class="s2">&quot;_out_report_path&quot;</span><span class="p">,</span>
        <span class="c1"># bool flag for writing reports</span>
        <span class="s2">&quot;_write_data_speed_up_reports&quot;</span><span class="p">,</span>
        <span class="c1"># data holder for output</span>
        <span class="s2">&quot;_view&quot;</span><span class="p">]</span>

    <span class="c1">#: base key (really nasty hack to tie in fixed route keys)</span>
    <span class="n">BASE_KEY</span> <span class="o">=</span> <span class="mh">0xFFFFFFF9</span>
    <span class="n">NEW_SEQ_KEY</span> <span class="o">=</span> <span class="mh">0xFFFFFFF8</span>
    <span class="n">FIRST_DATA_KEY</span> <span class="o">=</span> <span class="mh">0xFFFFFFF7</span>
    <span class="n">END_FLAG_KEY</span> <span class="o">=</span> <span class="mh">0xFFFFFFF6</span>
    <span class="n">TRANSACTION_ID_KEY</span> <span class="o">=</span> <span class="mh">0xFFFFFFF5</span>

    <span class="c1">#: to use with multicast stuff (reinjection acks have to be fixed route)</span>
    <span class="n">BASE_MASK</span> <span class="o">=</span> <span class="mh">0xFFFFFFFB</span>
    <span class="n">NEW_SEQ_KEY_OFFSET</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">FIRST_DATA_KEY_OFFSET</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">END_FLAG_KEY_OFFSET</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">TRANSACTION_ID_KEY_OFFSET</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># throttle on the transmission</span>
    <span class="n">_TRANSMISSION_THROTTLE_TIME</span> <span class="o">=</span> <span class="mf">0.000001</span>

    <span class="c1"># TRAFFIC_TYPE = EdgeTrafficType.MULTICAST</span>
    <span class="n">TRAFFIC_TYPE</span> <span class="o">=</span> <span class="n">EdgeTrafficType</span><span class="o">.</span><span class="n">FIXED_ROUTE</span>

    <span class="c1">#: report name for tracking used routers</span>
    <span class="n">OUT_REPORT_NAME</span> <span class="o">=</span> <span class="s2">&quot;routers_used_in_speed_up_process.rpt&quot;</span>
    <span class="c1">#: report name for tracking performance gains</span>
    <span class="n">IN_REPORT_NAME</span> <span class="o">=</span> <span class="s2">&quot;speeds_gained_in_speed_up_process.rpt&quot;</span>

    <span class="c1"># the end flag is set when the high bit of the sequence number word is set</span>
    <span class="n">_LAST_MESSAGE_FLAG_BIT_MASK</span> <span class="o">=</span> <span class="mh">0x80000000</span>
    <span class="c1"># corresponding mask for the actual sequence numbers</span>
    <span class="n">_SEQUENCE_NUMBER_MASK</span> <span class="o">=</span> <span class="mh">0x7fffffff</span>

    <span class="c1"># time outs used by the protocol for separate bits</span>
    <span class="n">_TIMEOUT_PER_RECEIVE_IN_SECONDS</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">_TIMEOUT_FOR_SENDING_IN_SECONDS</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="c1"># end flag for missing seq nums</span>
    <span class="n">_MISSING_SEQ_NUMS_END_FLAG</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>

    <span class="c1"># flag for saying missing all SEQ numbers</span>
    <span class="n">FLAG_FOR_MISSING_ALL_SEQUENCES</span> <span class="o">=</span> <span class="mh">0xFFFFFFFE</span>

    <span class="n">_ADDRESS_PACKET_BYTE_FORMAT</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span>
        <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">B&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BYTES_IN_FULL_PACKET_WITH_KEY</span><span class="p">))</span>

    <span class="c1"># Router timeouts, in mantissa,exponent form. See datasheet for details</span>
    <span class="n">_LONG_TIMEOUT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">_SHORT_TIMEOUT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_TEMP_TIMEOUT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">_ZERO_TIMEOUT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Initial port for the reverse IP tag (to be replaced later)</span>
    <span class="n">_TAG_INITIAL_PORT</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">extra_monitors_by_chip</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span>
            <span class="n">report_default_directory</span><span class="p">,</span>
            <span class="n">write_data_speed_up_reports</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param int x: Where this gatherer is.</span>
<span class="sd">        :param int y: Where this gatherer is.</span>
<span class="sd">        :param extra_monitors_by_chip: UNUSED</span>
<span class="sd">        :type extra_monitors_by_chip:</span>
<span class="sd">            dict(tuple(int,int), ExtraMonitorSupportMachineVertex)</span>
<span class="sd">        :param str ip_address:</span>
<span class="sd">            How to talk directly to the chip where the gatherer is.</span>
<span class="sd">        :param str report_default_directory: Where reporting is done.</span>
<span class="sd">        :param bool write_data_speed_up_reports:</span>
<span class="sd">            Whether to write low-level reports on data transfer speeds.</span>
<span class="sd">        :param iterable(~pacman.model.constraints.AbstractConstraint) \</span>
<span class="sd">                constraints:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataSpeedUpPacketGatherMachineVertex</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;SYSTEM:PacketGatherer(</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

        <span class="c1"># data holders for the output, and sequence numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># store of the extra monitors to location. helpful in data in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_monitors_by_chip</span> <span class="o">=</span> <span class="n">extra_monitors_by_chip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_missing_seq_nums_data_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Create a connection to be used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_word</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_address</span> <span class="o">=</span> <span class="n">ip_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_tag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># local provenance storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_data_items</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># create report if it doesn&#39;t already exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_report_path</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_default_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_REPORT_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_report_path</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_default_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_REPORT_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_data_speed_up_reports</span> <span class="o">=</span> <span class="n">write_data_speed_up_reports</span>

        <span class="c1"># Stored reinjection status for resetting timeouts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__throttled_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; slows down transmissions to allow spinnaker to keep up.</span>

<span class="sd">        :param ~.SDPMessage message: message to send</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># send first message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">send_sdp_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TRANSMISSION_THROTTLE_TIME</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@overrides</span><span class="p">(</span><span class="n">MachineVertex</span><span class="o">.</span><span class="n">resources_required</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">resources_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_resources_required</span><span class="p">()</span>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.update_transaction_id_from_machine"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.update_transaction_id_from_machine">[docs]</a>    <span class="k">def</span> <span class="nf">update_transaction_id_from_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txrx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Looks up from the machine what the current transaction ID is\</span>
<span class="sd">            and updates the data speed up gatherer.</span>

<span class="sd">        :param ~spinnman.transceiver.Transceiver txrx: SpiNNMan instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">=</span> <span class="n">txrx</span><span class="o">.</span><span class="n">read_user_1</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span><span class="o">.</span><span class="n">p</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.static_resources_required"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.static_resources_required">[docs]</a>    <span class="k">def</span> <span class="nf">static_resources_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :rtype: ~pacman.model.resources.ResourceContainer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ResourceContainer</span><span class="p">(</span>
            <span class="n">sdram</span><span class="o">=</span><span class="n">ConstantSDRAM</span><span class="p">(</span>
                <span class="n">CONFIG_SIZE</span> <span class="o">+</span> <span class="n">SDRAM_FOR_MISSING_SDP_SEQ_NUMS</span> <span class="o">+</span>
                <span class="n">SIZE_DATA_IN_CHIP_TO_KEY_SPACE</span><span class="p">),</span>
            <span class="n">iptags</span><span class="o">=</span><span class="p">[</span><span class="n">IPtagResource</span><span class="p">(</span>
                <span class="n">port</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_TAG_INITIAL_PORT</span><span class="p">,</span> <span class="n">strip_sdp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ip_address</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">traffic_identifier</span><span class="o">=</span><span class="s2">&quot;DATA_SPEED_UP&quot;</span><span class="p">)])</span></div>

    <span class="nd">@overrides</span><span class="p">(</span><span class="n">AbstractHasAssociatedBinary</span><span class="o">.</span><span class="n">get_binary_start_type</span><span class="p">)</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.get_binary_start_type"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.get_binary_start_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_binary_start_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ExecutableType</span><span class="o">.</span><span class="n">SYSTEM</span></div>

    <span class="nd">@inject_items</span><span class="p">({</span>
        <span class="s2">&quot;machine_graph&quot;</span><span class="p">:</span> <span class="s2">&quot;MemoryMachineGraph&quot;</span><span class="p">,</span>
        <span class="s2">&quot;routing_info&quot;</span><span class="p">:</span> <span class="s2">&quot;MemoryRoutingInfos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="s2">&quot;MemoryTags&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mc_data_chips_to_keys&quot;</span><span class="p">:</span> <span class="s2">&quot;DataInMulticastKeyToChipMap&quot;</span><span class="p">,</span>
        <span class="s2">&quot;router_timeout_key&quot;</span><span class="p">:</span> <span class="s2">&quot;SystemMulticastRouterTimeoutKeys&quot;</span><span class="p">,</span>
        <span class="s2">&quot;machine&quot;</span><span class="p">:</span> <span class="s2">&quot;MemoryExtendedMachine&quot;</span><span class="p">,</span>
        <span class="s2">&quot;app_id&quot;</span><span class="p">:</span> <span class="s2">&quot;APPID&quot;</span>
    <span class="p">})</span>
    <span class="nd">@overrides</span><span class="p">(</span>
        <span class="n">AbstractGeneratesDataSpecification</span><span class="o">.</span><span class="n">generate_data_specification</span><span class="p">,</span>
        <span class="n">additional_arguments</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;machine_graph&quot;</span><span class="p">,</span> <span class="s2">&quot;routing_info&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mc_data_chips_to_keys&quot;</span><span class="p">,</span> <span class="s2">&quot;machine&quot;</span><span class="p">,</span> <span class="s2">&quot;app_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;router_timeout_key&quot;</span>
        <span class="p">})</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.generate_data_specification"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.generate_data_specification">[docs]</a>    <span class="k">def</span> <span class="nf">generate_data_specification</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">placement</span><span class="p">,</span> <span class="n">machine_graph</span><span class="p">,</span> <span class="n">routing_info</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span>
            <span class="n">mc_data_chips_to_keys</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">router_timeout_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param ~pacman.model.graphs.machine.MachineGraph machine_graph:</span>
<span class="sd">            (injected)</span>
<span class="sd">        :param ~pacman.model.routing_info.RoutingInfo routing_info: (injected)</span>
<span class="sd">        :param ~pacman.model.tags.Tags tags: (injected)</span>
<span class="sd">        :param dict(tuple(int,int),int) mc_data_chips_to_keys: (injected)</span>
<span class="sd">        :param ~spinn_machine.Machine machine: (injected)</span>
<span class="sd">        :param int app_id: (injected)</span>
<span class="sd">        :param dict(tuple(int,int),int) router_timeout_key: (injected)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=too-many-arguments, arguments-differ</span>

        <span class="c1"># update my placement for future knowledge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span> <span class="o">=</span> <span class="n">placement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span> <span class="o">=</span> <span class="n">app_id</span>

        <span class="c1"># Create the data regions for hello world</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserve_memory_regions</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># the keys for the special cases</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRAFFIC_TYPE</span> <span class="o">==</span> <span class="n">EdgeTrafficType</span><span class="o">.</span><span class="n">MULTICAST</span><span class="p">:</span>
            <span class="n">base_key</span> <span class="o">=</span> <span class="n">routing_info</span><span class="o">.</span><span class="n">get_first_key_for_edge</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">machine_graph</span><span class="o">.</span><span class="n">get_edges_ending_at_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">new_seq_key</span> <span class="o">=</span> <span class="n">base_key</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">NEW_SEQ_KEY_OFFSET</span>
            <span class="n">first_data_key</span> <span class="o">=</span> <span class="n">base_key</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIRST_DATA_KEY_OFFSET</span>
            <span class="n">end_flag_key</span> <span class="o">=</span> <span class="n">base_key</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">END_FLAG_KEY_OFFSET</span>
            <span class="n">transaction_id_key</span> <span class="o">=</span> <span class="n">base_key</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRANSACTION_ID_KEY_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_seq_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NEW_SEQ_KEY</span>
            <span class="n">first_data_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIRST_DATA_KEY</span>
            <span class="n">end_flag_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">END_FLAG_KEY</span>
            <span class="n">base_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_KEY</span>
            <span class="n">transaction_id_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRANSACTION_ID_KEY</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">switch_write_focus</span><span class="p">(</span><span class="n">_DATA_REGIONS</span><span class="o">.</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">new_seq_key</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">first_data_key</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">transaction_id_key</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">end_flag_key</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">base_key</span><span class="p">)</span>

        <span class="c1"># locate the tag ID for our data and update with a port</span>
        <span class="c1"># Note: The port doesn&#39;t matter as we are going to override this later</span>
        <span class="n">iptags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">get_ip_tags_for_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">iptag</span> <span class="o">=</span> <span class="n">iptags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">iptag</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_tag</span> <span class="o">=</span> <span class="n">iptag</span><span class="o">.</span><span class="n">tag</span>

        <span class="c1"># write mc chip key map</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">switch_write_focus</span><span class="p">(</span><span class="n">_DATA_REGIONS</span><span class="o">.</span><span class="n">CHIP_TO_KEY_SPACE</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">chips_on_board</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">get_existing_xys_on_board</span><span class="p">(</span>
            <span class="n">machine</span><span class="o">.</span><span class="n">get_chip_at</span><span class="p">(</span><span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">)))</span>

        <span class="c1"># write how many chips to read</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chips_on_board</span><span class="p">))</span>

        <span class="c1"># write the broad cast keys for timeouts</span>
        <span class="n">reinjection_base_key</span> <span class="o">=</span> <span class="n">router_timeout_key</span><span class="p">[(</span><span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">)]</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">reinjection_base_key</span><span class="p">)</span>

        <span class="c1"># write each chip x and y and base key</span>
        <span class="k">for</span> <span class="n">chip_xy</span> <span class="ow">in</span> <span class="n">chips_on_board</span><span class="p">:</span>
            <span class="n">board_chip_x</span><span class="p">,</span> <span class="n">board_chip_y</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_local_xy</span><span class="p">(</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">get_chip_at</span><span class="p">(</span><span class="o">*</span><span class="n">chip_xy</span><span class="p">))</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">board_chip_x</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">board_chip_y</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">mc_data_chips_to_keys</span><span class="p">[</span><span class="n">chip_xy</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;for chip </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> base key is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="n">chip_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mc_data_chips_to_keys</span><span class="p">[</span><span class="n">chip_xy</span><span class="p">])</span>

        <span class="c1"># End-of-Spec:</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">end_specification</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_reserve_memory_regions</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes the DSG regions memory sizes. Static so that it can be used\</span>
<span class="sd">            by the application vertex.</span>

<span class="sd">        :param ~.DataSpecificationGenerator spec: spec file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">reserve_memory_region</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">_DATA_REGIONS</span><span class="o">.</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">CONFIG_SIZE</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">reserve_memory_region</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">_DATA_REGIONS</span><span class="o">.</span><span class="n">CHIP_TO_KEY_SPACE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">SIZE_DATA_IN_CHIP_TO_KEY_SPACE</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;mc_key_map&quot;</span><span class="p">)</span>

    <span class="nd">@overrides</span><span class="p">(</span><span class="n">AbstractHasAssociatedBinary</span><span class="o">.</span><span class="n">get_binary_file_name</span><span class="p">)</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.get_binary_file_name"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.get_binary_file_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_binary_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;data_speed_up_packet_gatherer.aplx&quot;</span></div>

    <span class="nd">@overrides</span><span class="p">(</span><span class="n">AbstractProvidesLocalProvenanceData</span><span class="o">.</span><span class="n">get_local_provenance_data</span><span class="p">)</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.get_local_provenance_data"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.get_local_provenance_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_local_provenance_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">prov_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">significant_losses</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">top_level_name</span> <span class="o">=</span> <span class="s2">&quot;Provenance_for_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">placement</span><span class="p">,</span> <span class="n">memory_address</span><span class="p">,</span> <span class="n">length_in_bytes</span><span class="p">)</span> <span class="ow">in</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_data_items</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="c1"># handle duplicates of the same calls</span>
            <span class="n">times_extracted_the_same_thing</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">time_taken</span><span class="p">,</span> <span class="n">lost_seq_nums</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_data_items</span><span class="p">[</span>
                    <span class="n">placement</span><span class="p">,</span> <span class="n">memory_address</span><span class="p">,</span> <span class="n">length_in_bytes</span><span class="p">]:</span>
                <span class="c1"># handle time</span>
                <span class="n">chip_name</span> <span class="o">=</span> <span class="s2">&quot;chip</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">last_name</span> <span class="o">=</span> <span class="s2">&quot;Memory_address:</span><span class="si">{}</span><span class="s2">:Length_in_bytes:</span><span class="si">{}</span><span class="s2">&quot;</span>\
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_address</span><span class="p">,</span> <span class="n">length_in_bytes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">times_extracted_the_same_thing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;run</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;run</span><span class="si">{}</span><span class="s2">iteration</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span> <span class="n">times_extracted_the_same_thing</span><span class="p">)</span>
                <span class="n">prov_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProvenanceDataItem</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">top_level_name</span><span class="p">,</span> <span class="s2">&quot;extraction_time&quot;</span><span class="p">,</span> <span class="n">chip_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span>
                     <span class="n">iteration_name</span><span class="p">],</span>
                    <span class="n">time_taken</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
                <span class="n">times_extracted_the_same_thing</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># handle lost sequence numbers</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n_lost_seq_nums</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lost_seq_nums</span><span class="p">):</span>
                    <span class="c1"># Zeroes are not reported at all</span>
                    <span class="k">if</span> <span class="n">n_lost_seq_nums</span><span class="p">:</span>
                        <span class="n">prov_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProvenanceDataItem</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">top_level_name</span><span class="p">,</span> <span class="s2">&quot;lost_seq_nums&quot;</span><span class="p">,</span> <span class="n">chip_name</span><span class="p">,</span>
                             <span class="n">last_name</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span>
                             <span class="s2">&quot;iteration_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span>
                            <span class="n">n_lost_seq_nums</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="p">(</span>
                                <span class="n">n_lost_seq_nums</span> <span class="o">&gt;</span> <span class="n">_MINOR_LOSS_THRESHOLD</span><span class="p">),</span>
                            <span class="n">message</span><span class="o">=</span><span class="n">_MINOR_LOSS_MESSAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">length_in_bytes</span><span class="p">,</span> <span class="n">memory_address</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                <span class="n">n_lost_seq_nums</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">n_lost_seq_nums</span> <span class="o">&gt;</span> <span class="n">_MAJOR_LOSS_THRESHOLD</span><span class="p">:</span>
                        <span class="n">significant_losses</span><span class="p">[</span><span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="n">significant_losses</span><span class="p">:</span>
            <span class="n">n_times</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">significant_losses</span><span class="p">[</span><span class="n">chip</span><span class="p">])</span>
            <span class="n">chip_name</span> <span class="o">=</span> <span class="s2">&quot;chip</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">)</span>
            <span class="n">prov_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProvenanceDataItem</span><span class="p">(</span>
                <span class="p">[</span><span class="n">top_level_name</span><span class="p">,</span> <span class="s2">&quot;serious_lost_seq_num_count&quot;</span><span class="p">,</span> <span class="n">chip_name</span><span class="p">],</span>
                <span class="n">n_times</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">_MAJOR_LOSS_MESSAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">chip</span><span class="p">,</span> <span class="n">n_times</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_data_items</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prov_items</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.locate_correct_write_data_function_for_chip_location"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.locate_correct_write_data_function_for_chip_location">[docs]</a>    <span class="k">def</span> <span class="nf">locate_correct_write_data_function_for_chip_location</span><span class="p">(</span>
            <span class="n">uses_advanced_monitors</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span>
            <span class="n">extra_monitor_cores_to_ethernet_connection_map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Supports other components figuring out which gatherer and function\</span>
<span class="sd">            to call for writing data onto SpiNNaker.</span>

<span class="sd">        :param bool uses_advanced_monitors:</span>
<span class="sd">            Whether the system is using advanced monitors</span>
<span class="sd">        :param ~spinn_machine.Machine machine: the SpiNNMachine instance</span>
<span class="sd">        :param int x: the chip x coordinate to write data to</span>
<span class="sd">        :param int y: the chip y coordinate to write data to</span>
<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">            the SpiNNMan instance</span>
<span class="sd">        :param extra_monitor_cores_to_ethernet_connection_map:</span>
<span class="sd">            mapping between cores and connections</span>
<span class="sd">        :type extra_monitor_cores_to_ethernet_connection_map:</span>
<span class="sd">            dict(tuple(int,int), DataSpeedUpPacketGatherMachineVertex)</span>
<span class="sd">        :return: a write function of either a LPG or the spinnMan</span>
<span class="sd">        :rtype: callable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uses_advanced_monitors</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transceiver</span><span class="o">.</span><span class="n">write_memory</span>

        <span class="n">chip</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_chip_at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">ethernet_connected_chip</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_chip_at</span><span class="p">(</span>
            <span class="n">chip</span><span class="o">.</span><span class="n">nearest_ethernet_x</span><span class="p">,</span> <span class="n">chip</span><span class="o">.</span><span class="n">nearest_ethernet_y</span><span class="p">)</span>
        <span class="n">gatherer</span> <span class="o">=</span> <span class="n">extra_monitor_cores_to_ethernet_connection_map</span><span class="p">[</span>
            <span class="n">ethernet_connected_chip</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ethernet_connected_chip</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">gatherer</span><span class="o">.</span><span class="n">send_data_into_spinnaker</span></div>

    <span class="k">def</span> <span class="nf">_generate_data_in_report</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">time_diff</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
            <span class="n">address_written_to</span><span class="p">,</span> <span class="n">missing_seq_nums</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes the data in report for this stage.</span>

<span class="sd">        :param ~datetime.timedelta time_diff:</span>
<span class="sd">            the time taken to write the memory</span>
<span class="sd">        :param int data_size: the size of data that was written in bytes</span>
<span class="sd">        :param int x:</span>
<span class="sd">            the location in machine where the data was written to X axis</span>
<span class="sd">        :param int y:</span>
<span class="sd">            the location in machine where the data was written to Y axis</span>
<span class="sd">        :param int address_written_to: where in SDRAM it was written to</span>
<span class="sd">        :param list(set(int)) missing_seq_nums:</span>
<span class="sd">            the set of missing sequence numbers per data transmission attempt</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_in_report_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_in_report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;x</span><span class="se">\t\t</span><span class="s2"> y</span><span class="se">\t\t</span><span class="s2"> SDRAM address</span><span class="se">\t\t</span><span class="s2"> size in bytes</span><span class="se">\t\t\t</span><span class="s2">&quot;</span>
                    <span class="s2">&quot; time took </span><span class="se">\t\t\t</span><span class="s2"> Mb/s </span><span class="se">\t\t\t</span><span class="s2"> missing sequence numbers</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;------------------------------------------------&quot;</span>
                    <span class="s2">&quot;------------------------------------------------&quot;</span>
                    <span class="s2">&quot;-------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">time_took_ms</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time_diff</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span>
                             <span class="n">time_diff</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span>
        <span class="n">megabits</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">*</span> <span class="mf">8.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">BYTES_PER_KB</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_took_ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mbs</span> <span class="o">=</span> <span class="s2">&quot;unknown, below threshold&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mbs</span> <span class="o">=</span> <span class="n">megabits</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">time_took_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100000.0</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_in_report_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{}</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{}</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{}</span><span class="se">\t\t\t\t</span><span class="s2"> </span><span class="si">{}</span><span class="se">\t\t\t</span><span class="s2"> </span><span class="si">{}</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">address_written_to</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">time_took_ms</span><span class="p">,</span>
                    <span class="n">mbs</span><span class="p">,</span> <span class="n">missing_seq_nums</span><span class="p">))</span>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.send_data_into_spinnaker"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.send_data_into_spinnaker">[docs]</a>    <span class="k">def</span> <span class="nf">send_data_into_spinnaker</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cpu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_filename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="sd">&quot;&quot;&quot; Sends a block of data into SpiNNaker to a given chip.</span>

<span class="sd">        :param int x: chip x for data</span>
<span class="sd">        :param int y: chip y for data</span>
<span class="sd">        :param int base_address: the address in SDRAM to start writing memory</span>
<span class="sd">        :param data: the data to write (or filename to load data from, \</span>
<span class="sd">            if `is_filename` is True; that&#39;s the only time this is a str)</span>
<span class="sd">        :type data: bytes or bytearray or memoryview or str</span>
<span class="sd">        :param int n_bytes: how many bytes to read, or None if not set</span>
<span class="sd">        :param int offset: where in the data to start from</span>
<span class="sd">        :param int cpu:</span>
<span class="sd">        :param bool is_filename: whether data is actually a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if file, read in and then process as normal</span>
        <span class="k">if</span> <span class="n">is_filename</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;when using a file, you can only have a offset of 0&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">FileDataReader</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="c1"># n_bytes=None already means &#39;read everything&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n_bytes</span><span class="p">)</span>  <span class="c1"># pylint: disable=no-member</span>
            <span class="c1"># Number of bytes to write is now length of buffer we have</span>
            <span class="n">n_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n_bytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">transceiver</span> <span class="o">=</span> <span class="n">get_simulator</span><span class="p">()</span><span class="o">.</span><span class="n">transceiver</span>

        <span class="c1"># start time recording</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1"># send data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_data_via_extra_monitors</span><span class="p">(</span>
            <span class="n">transceiver</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">n_bytes</span> <span class="o">+</span> <span class="n">offset</span><span class="p">])</span>
        <span class="c1"># end time recording</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">VERIFY_SENT_DATA</span><span class="p">:</span>
            <span class="n">original_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">n_bytes</span> <span class="o">+</span> <span class="n">offset</span><span class="p">])</span>
            <span class="n">verified_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">transceiver</span><span class="o">.</span><span class="n">read_memory</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__verify_sent_data_py2</span><span class="p">(</span>
                    <span class="n">original_data</span><span class="p">,</span> <span class="n">verified_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__verify_sent_data_py3</span><span class="p">(</span>
                    <span class="n">original_data</span><span class="p">,</span> <span class="n">verified_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">)</span>

        <span class="c1"># write report</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_data_speed_up_reports</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_data_in_report</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">time_diff</span><span class="o">=</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                <span class="n">data_size</span><span class="o">=</span><span class="n">n_bytes</span><span class="p">,</span> <span class="n">address_written_to</span><span class="o">=</span><span class="n">base_address</span><span class="p">,</span>
                <span class="n">missing_seq_nums</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_missing_seq_nums_data_in</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__verify_sent_data_py2</span><span class="p">(</span>
            <span class="n">original_data</span><span class="p">,</span> <span class="n">verified_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">original_data</span> <span class="o">!=</span> <span class="n">verified_data</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VARIANCE: chip:</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> address:</span><span class="si">{}</span><span class="s2"> len:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;original:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%02X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">original_data</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;verified:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%02X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">verified_data</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">original_data</span><span class="p">,</span> <span class="n">verified_data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;damn at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__verify_sent_data_py3</span><span class="p">(</span>
            <span class="n">original_data</span><span class="p">,</span> <span class="n">verified_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">original_data</span> <span class="o">!=</span> <span class="n">verified_data</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VARIANCE: chip:</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> address:</span><span class="si">{}</span><span class="s2"> len:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;original:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">original_data</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;verified:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verified_data</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">original_data</span><span class="p">,</span> <span class="n">verified_data</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;damn at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__make_sdp_message</span><span class="p">(</span><span class="n">placement</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param ~.Placement placement:</span>
<span class="sd">        :param SDP_PORTS port:</span>
<span class="sd">        :param bytearray payload:</span>
<span class="sd">        :rtype: ~.SDPMessage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SDPMessage</span><span class="p">(</span>
            <span class="n">sdp_header</span><span class="o">=</span><span class="n">SDPHeader</span><span class="p">(</span>
                <span class="n">destination_chip_x</span><span class="o">=</span><span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">destination_chip_y</span><span class="o">=</span><span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">destination_cpu</span><span class="o">=</span><span class="n">placement</span><span class="o">.</span><span class="n">p</span><span class="p">,</span>
                <span class="n">destination_port</span><span class="o">=</span><span class="n">port</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="n">SDPFlag</span><span class="o">.</span><span class="n">REPLY_NOT_EXPECTED</span><span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_send_data_via_extra_monitors</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">destination_chip_x</span><span class="p">,</span> <span class="n">destination_chip_y</span><span class="p">,</span>
            <span class="n">start_address</span><span class="p">,</span> <span class="n">data_to_write</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sends data using the extra monitor cores</span>

<span class="sd">        :param ~.Transceiver transceiver: the SpiNNMan instance</span>
<span class="sd">        :param int destination_chip_x: chip x</span>
<span class="sd">        :param int destination_chip_y: chip y</span>
<span class="sd">        :param int start_address: start address in SDRAM to write data to</span>
<span class="sd">        :param bytearray data_to_write: the data to write</span>
<span class="sd">        :param int start_address: the base SDRAM address</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set up the connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">SCAMPConnection</span><span class="p">(</span>
            <span class="n">chip_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">chip_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">remote_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reprogram_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">)</span>

        <span class="c1"># how many packets after first one we need to send</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span> <span class="o">=</span> <span class="n">ceildiv</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">data_to_write</span><span class="p">),</span> <span class="n">BYTES_IN_FULL_PACKET_WITH_KEY</span><span class="p">)</span>

        <span class="c1"># determine board chip IDs, as the LPG does not know machine scope IDs</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="n">transceiver</span><span class="o">.</span><span class="n">get_machine_details</span><span class="p">()</span>
        <span class="n">chip</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_chip_at</span><span class="p">(</span><span class="n">destination_chip_x</span><span class="p">,</span> <span class="n">destination_chip_y</span><span class="p">)</span>
        <span class="n">dest_x</span><span class="p">,</span> <span class="n">dest_y</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_local_xy</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">dest_x</span> <span class="o">&lt;&lt;</span> <span class="n">DEST_X_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">dest_y</span>

        <span class="c1"># for safety, check the transaction id from the machine before updating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_transaction_id_from_machine</span><span class="p">(</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TRANSACTION_ID_CAP</span>
        <span class="n">time_out_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># verify completed</span>
        <span class="n">received_confirmation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">received_confirmation</span><span class="p">:</span>

            <span class="c1"># send initial attempt at sending all the data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_all_data_based_packets</span><span class="p">(</span><span class="n">data_to_write</span><span class="p">,</span> <span class="n">start_address</span><span class="p">)</span>

            <span class="c1"># Don&#39;t create a missing buffer until at least one packet has</span>
            <span class="c1"># come back.</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="n">received_confirmation</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># try to receive a confirmation of some sort from spinnaker</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_TIMEOUT_PER_RECEIVE_IN_SECONDS</span><span class="p">)</span>
                    <span class="n">time_out_count</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># Read command and transaction id</span>
                    <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">_TWO_WORDS</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># If wrong transaction id, ignore packet</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">!=</span> <span class="n">transaction_id</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Decide what to do with the packet</span>
                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">DATA_IN_COMMANDS</span><span class="o">.</span><span class="n">RECEIVE_FINISHED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                        <span class="n">received_confirmation</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">DATA_IN_COMMANDS</span><span class="o">.</span><span class="n">RECEIVE_MISSING_SEQ_DATA</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown command </span><span class="si">{}</span><span class="s2"> received&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">cmd</span><span class="p">))</span>

                    <span class="c1"># The currently received packet has missing sequence</span>
                    <span class="c1"># numbers. Accumulate and dispatch transactionId when</span>
                    <span class="c1"># we&#39;ve got them all.</span>
                    <span class="k">if</span> <span class="n">missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_missing_seq_nums_data_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
                    <span class="n">seen_last</span><span class="p">,</span> <span class="n">seen_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_in_missing_seq_nums</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">BYTES_FOR_RECEPTION_COMMAND_AND_ADDRESS_HEADER</span><span class="p">,</span>
                        <span class="n">missing</span><span class="p">)</span>

                    <span class="c1"># Check that you&#39;ve seen something that implies ready</span>
                    <span class="c1"># to retransmit.</span>
                    <span class="k">if</span> <span class="n">seen_all</span> <span class="ow">or</span> <span class="n">seen_last</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_outgoing_retransmit_missing_seq_nums</span><span class="p">(</span>
                            <span class="n">data_to_write</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
                        <span class="n">missing</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                <span class="k">except</span> <span class="n">SpinnmanTimeoutException</span><span class="p">:</span>  <span class="c1"># if time out, keep trying</span>
                    <span class="c1"># if the timeout has not occurred x times, keep trying</span>
                    <span class="n">time_out_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">time_out_count</span> <span class="o">&gt;</span> <span class="n">TIMEOUT_RETRY_LIMIT</span><span class="p">:</span>
                        <span class="n">emergency_recover_state_from_failure</span><span class="p">(</span>
                            <span class="n">transceiver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SpinnFrontEndException</span><span class="p">(</span>
                            <span class="n">TIMEOUT_MESSAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_out_count</span><span class="p">))</span>

                    <span class="c1"># If we never received a packet, we will never have</span>
                    <span class="c1"># created the buffer, so send everything again</span>
                    <span class="k">if</span> <span class="n">missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_outgoing_retransmit_missing_seq_nums</span><span class="p">(</span>
                            <span class="n">data_to_write</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
                    <span class="n">missing</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Close the connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_in_missing_seq_nums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">seq_nums</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; handles a missing seq num packet from spinnaker</span>

<span class="sd">        :param bytearray data: the data to translate into missing seq nums</span>
<span class="sd">        :param int position: the position in the data to write.</span>
<span class="sd">        :param set(int) seq_nums: a set of sequence numbers to add to</span>
<span class="sd">        :return: seen_last flag and seen_all flag</span>
<span class="sd">        :rtype: tuple(bool, bool)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># find how many elements are in this packet</span>
        <span class="n">n_elements</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span> <span class="o">//</span> <span class="n">BYTES_PER_WORD</span>

        <span class="c1"># store missing</span>
        <span class="n">new_seq_nums</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
            <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">I&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_elements</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>

        <span class="c1"># add missing seqs accordingly</span>
        <span class="n">seen_last</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">seen_all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">new_seq_nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MISSING_SEQ_NUMS_END_FLAG</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">new_seq_nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">seen_last</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">new_seq_nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_FOR_MISSING_ALL_SEQUENCES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">missing_seq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span><span class="p">):</span>
                <span class="n">seq_nums</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">missing_seq</span><span class="p">)</span>
            <span class="n">seen_all</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq_nums</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_seq_nums</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">seen_last</span><span class="p">,</span> <span class="n">seen_all</span>

    <span class="k">def</span> <span class="nf">_outgoing_retransmit_missing_seq_nums</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">data_to_write</span><span class="p">,</span> <span class="n">missing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Transmits back into SpiNNaker the missing data based off missing\</span>
<span class="sd">            sequence numbers</span>

<span class="sd">        :param bytearray data_to_write: the data to write.</span>
<span class="sd">        :param set(int) missing: a set of missing sequence numbers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">missing_seqs_as_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
        <span class="n">missing_seqs_as_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># send seq data</span>
        <span class="k">for</span> <span class="n">missing_seq_num</span> <span class="ow">in</span> <span class="n">missing_seqs_as_list</span><span class="p">:</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_data_in_data_from_seq_number</span><span class="p">(</span>
                <span class="n">data_to_write</span><span class="p">,</span> <span class="n">missing_seq_num</span><span class="p">,</span>
                <span class="n">DATA_IN_COMMANDS</span><span class="o">.</span><span class="n">SEND_SEQ_DATA</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__throttled_send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># request an update on what is missing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_tell_flag</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_position_from_seq_number</span><span class="p">(</span><span class="n">seq_num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates where in the raw data to start reading from, given a\</span>
<span class="sd">            sequence number</span>

<span class="sd">        :param int seq_num: the sequence number to determine position from</span>
<span class="sd">        :return: the position in the byte data</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BYTES_IN_FULL_PACKET_WITH_KEY</span> <span class="o">*</span> <span class="n">seq_num</span>

    <span class="k">def</span> <span class="nf">_calculate_data_in_data_from_seq_number</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">data_to_write</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine the data needed to be sent to the SpiNNaker machine\</span>
<span class="sd">            given a sequence number</span>

<span class="sd">        :param bytearray data_to_write:</span>
<span class="sd">            the data to write to the SpiNNaker machine</span>
<span class="sd">        :param int seq_num: the seq num to get the data for</span>
<span class="sd">        :param int command_id:</span>
<span class="sd">        :param position: the position in the data to write to spinnaker</span>
<span class="sd">        :type position: int or None</span>
<span class="sd">        :return: SDP message and how much data has been written</span>
<span class="sd">        :rtype: tuple(~.SDPMessage, int)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check for last packet</span>
        <span class="n">packet_data_length</span> <span class="o">=</span> <span class="n">BYTES_IN_FULL_PACKET_WITH_KEY</span>

        <span class="c1"># determine position in data if not given</span>
        <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_position_from_seq_number</span><span class="p">(</span><span class="n">seq_num</span><span class="p">)</span>

        <span class="c1"># if less than a full packet worth of data, adjust length</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">+</span> <span class="n">packet_data_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_write</span><span class="p">):</span>
            <span class="n">packet_data_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_write</span><span class="p">)</span> <span class="o">-</span> <span class="n">position</span>

        <span class="k">if</span> <span class="n">packet_data_length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;weird packet data length.&quot;</span><span class="p">)</span>

        <span class="c1"># determine the true packet length (with header)</span>
        <span class="n">packet_length</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">packet_data_length</span> <span class="o">+</span> <span class="n">BYTES_FOR_COMMAND_AND_ADDRESS_HEADER</span><span class="p">)</span>

        <span class="c1"># create struct</span>
        <span class="n">packet_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">packet_length</span><span class="p">)</span>
        <span class="n">_THREE_WORDS</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span>
            <span class="n">packet_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">)</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span>
            <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">B&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">packet_data_length</span><span class="p">),</span> <span class="n">packet_data</span><span class="p">,</span>
            <span class="n">BYTES_FOR_COMMAND_AND_ADDRESS_HEADER</span><span class="p">,</span>
            <span class="o">*</span><span class="n">data_to_write</span><span class="p">[</span><span class="n">position</span><span class="p">:</span><span class="n">position</span><span class="o">+</span><span class="n">packet_data_length</span><span class="p">])</span>

        <span class="c1"># debug</span>
        <span class="c1"># self._print_out_packet_data(packet_data, position)</span>

        <span class="c1"># build sdp packet</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_sdp_message</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span><span class="p">,</span> <span class="n">SDP_PORTS</span><span class="o">.</span><span class="n">EXTRA_MONITOR_CORE_DATA_IN_SPEED_UP</span><span class="p">,</span>
            <span class="n">packet_data</span><span class="p">)</span>

        <span class="c1"># return message for sending, and the length in data sent</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">,</span> <span class="n">packet_data_length</span>

    <span class="k">def</span> <span class="nf">_send_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send location as separate message.</span>

<span class="sd">        :param int start_address: SDRAM location</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">send_sdp_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__make_sdp_message</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span><span class="p">,</span> <span class="n">SDP_PORTS</span><span class="o">.</span><span class="n">EXTRA_MONITOR_CORE_DATA_IN_SPEED_UP</span><span class="p">,</span>
            <span class="n">_FIVE_WORDS</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="n">DATA_IN_COMMANDS</span><span class="o">.</span><span class="n">SEND_DATA_TO_LOCATION</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_word</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;start address for transaction </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span> <span class="n">start_address</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_send_tell_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send tell flag as separate message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">send_sdp_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__make_sdp_message</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span><span class="p">,</span> <span class="n">SDP_PORTS</span><span class="o">.</span><span class="n">EXTRA_MONITOR_CORE_DATA_IN_SPEED_UP</span><span class="p">,</span>
            <span class="n">_TWO_WORDS</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="n">DATA_IN_COMMANDS</span><span class="o">.</span><span class="n">SEND_TELL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_send_all_data_based_packets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_to_write</span><span class="p">,</span> <span class="n">start_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send all the data as one block.</span>

<span class="sd">        :param bytearray data_to_write: the data to send</span>
<span class="sd">        :param int start_address:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Send the location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_location</span><span class="p">(</span><span class="n">start_address</span><span class="p">)</span>

        <span class="c1"># where in the data we are currently up to</span>
        <span class="n">position_in_data</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># send rest of data</span>
        <span class="k">for</span> <span class="n">seq_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span><span class="p">):</span>
            <span class="c1"># put in command flag and seq num</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">length_to_send</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_data_in_data_from_seq_number</span><span class="p">(</span>
                    <span class="n">data_to_write</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span>
                    <span class="n">DATA_IN_COMMANDS</span><span class="o">.</span><span class="n">SEND_SEQ_DATA</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">position_in_data</span><span class="p">)</span>
            <span class="n">position_in_data</span> <span class="o">+=</span> <span class="n">length_to_send</span>

            <span class="c1"># send the message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__throttled_send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;sent seq </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> bytes&quot;</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span> <span class="n">length_to_send</span><span class="p">)</span>

        <span class="c1"># check for end flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_tell_flag</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;sent end flag&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.streaming"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.streaming">[docs]</a>    <span class="k">def</span> <span class="nf">streaming</span><span class="p">(</span><span class="n">gatherers</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method for setting the router timeouts to a state usable\</span>
<span class="sd">            for data streaming via a Python context manager (i.e., using\</span>
<span class="sd">            the `with` statement).</span>

<span class="sd">        :param list(DataSpeedUpPacketGatherMachineVertex) gatherers:</span>
<span class="sd">            All the gatherers that are to be set</span>
<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">            the SpiNNMan instance</span>
<span class="sd">        :param list(ExtraMonitorSupportMachineVertex) extra_monitor_cores:</span>
<span class="sd">            the extra monitor cores to set</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">            placements object</span>
<span class="sd">        :return: a context manager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_StreamingContextManager</span><span class="p">(</span>
            <span class="n">gatherers</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.set_cores_for_data_streaming"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.set_cores_for_data_streaming">[docs]</a>    <span class="k">def</span> <span class="nf">set_cores_for_data_streaming</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method for setting the router timeouts to a state usable\</span>
<span class="sd">            for data streaming.</span>

<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">            the SpiNNMan instance</span>
<span class="sd">        :param list(ExtraMonitorSupportMachineVertex) extra_monitor_cores:</span>
<span class="sd">            the extra monitor cores to set</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">            placements object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lead_monitor</span> <span class="o">=</span> <span class="n">extra_monitor_cores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Store the last reinjection status for resetting</span>
        <span class="c1"># NOTE: This assumes the status is the same on all cores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span> <span class="o">=</span> <span class="n">lead_monitor</span><span class="o">.</span><span class="n">get_reinjection_status</span><span class="p">(</span>
            <span class="n">placements</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">)</span>

        <span class="c1"># Set to not inject dropped packets</span>
        <span class="n">lead_monitor</span><span class="o">.</span><span class="n">set_reinjection_packets</span><span class="p">(</span>
            <span class="n">placements</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span>
            <span class="n">point_to_point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multicast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nearest_neighbour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fixed_route</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Clear any outstanding packets from reinjection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_reinjection_queue</span><span class="p">(</span><span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span>

        <span class="c1"># set time outs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_router_emergency_timeout</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SHORT_TIMEOUT</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_router_time_outs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_LONG_TIMEOUT</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.load_application_routing_tables"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.load_application_routing_tables">[docs]</a>    <span class="k">def</span> <span class="nf">load_application_routing_tables</span><span class="p">(</span>
            <span class="n">transceiver</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set all chips to have application table loaded in the router.</span>

<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">            the SpiNNMan instance</span>
<span class="sd">        :param list(ExtraMonitorSupportMachineVertex) extra_monitor_cores:</span>
<span class="sd">            the extra monitor cores to set</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">            placements object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_monitor_cores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">load_application_mc_routes</span><span class="p">(</span>
            <span class="n">placements</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.load_system_routing_tables"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.load_system_routing_tables">[docs]</a>    <span class="k">def</span> <span class="nf">load_system_routing_tables</span><span class="p">(</span>
            <span class="n">transceiver</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set all chips to have the system table loaded in the router</span>

<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">            the SpiNNMan instance</span>
<span class="sd">        :param list(ExtraMonitorSupportMachineVertex) extra_monitor_cores:</span>
<span class="sd">            the extra monitor cores to set</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">            placements object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_monitor_cores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">load_system_mc_routes</span><span class="p">(</span>
            <span class="n">placements</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.set_router_time_outs"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.set_router_time_outs">[docs]</a>    <span class="k">def</span> <span class="nf">set_router_time_outs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the wait1 field for a set of routers.</span>

<span class="sd">        :param tuple(int,int) timeout:</span>
<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mantissa</span><span class="p">,</span> <span class="n">exponent</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="n">core_subsets</span> <span class="o">=</span> <span class="n">convert_vertices_to_core_subset</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">placements</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">SetRouterTimeoutProcess</span><span class="p">(</span>
            <span class="n">transceiver</span><span class="o">.</span><span class="n">scamp_connection_selector</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">set_timeout</span><span class="p">(</span><span class="n">mantissa</span><span class="p">,</span> <span class="n">exponent</span><span class="p">,</span> <span class="n">core_subsets</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="n">emergency_recover_state_from_failure</span><span class="p">(</span>
                <span class="n">transceiver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">placements</span><span class="o">.</span><span class="n">get_placement_of_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.set_router_emergency_timeout"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.set_router_emergency_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">set_router_emergency_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the wait2 field for a set of routers.</span>

<span class="sd">        :param tuple(int,int) timeout:</span>
<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mantissa</span><span class="p">,</span> <span class="n">exponent</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="n">core_subsets</span> <span class="o">=</span> <span class="n">convert_vertices_to_core_subset</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">placements</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">SetRouterEmergencyTimeoutProcess</span><span class="p">(</span>
            <span class="n">transceiver</span><span class="o">.</span><span class="n">scamp_connection_selector</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">set_timeout</span><span class="p">(</span><span class="n">mantissa</span><span class="p">,</span> <span class="n">exponent</span><span class="p">,</span> <span class="n">core_subsets</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="n">emergency_recover_state_from_failure</span><span class="p">(</span>
                <span class="n">transceiver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">placements</span><span class="o">.</span><span class="n">get_placement_of_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.clear_reinjection_queue"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.clear_reinjection_queue">[docs]</a>    <span class="k">def</span> <span class="nf">clear_reinjection_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clears the queues for reinjection.</span>

<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">            the spinnMan interface</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">            the placements object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">core_subsets</span> <span class="o">=</span> <span class="n">convert_vertices_to_core_subset</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">placements</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">ClearQueueProcess</span><span class="p">(</span><span class="n">transceiver</span><span class="o">.</span><span class="n">scamp_connection_selector</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">reset_counters</span><span class="p">(</span><span class="n">core_subsets</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="n">emergency_recover_state_from_failure</span><span class="p">(</span>
                <span class="n">transceiver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">placements</span><span class="o">.</span><span class="n">get_placement_of_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.unset_cores_for_data_streaming"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.unset_cores_for_data_streaming">[docs]</a>    <span class="k">def</span> <span class="nf">unset_cores_for_data_streaming</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method for restoring the router timeouts to normal after\</span>
<span class="sd">            being in a state usable for data streaming.</span>

<span class="sd">        :param ~spinnman.transceiver.Transceiver transceiver:</span>
<span class="sd">            the SpiNNMan instance</span>
<span class="sd">        :param list(ExtraMonitorSupportMachineVertex) extra_monitor_cores:</span>
<span class="sd">            the extra monitor cores to set</span>
<span class="sd">        :param ~pacman.model.placements.Placements placements:</span>
<span class="sd">            placements object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the routers to temporary values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_router_time_outs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_TEMP_TIMEOUT</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_router_emergency_timeout</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ZERO_TIMEOUT</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cores have not been set for data extraction, so can&#39;t be&quot;</span>
                <span class="s2">&quot; unset&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_router_time_outs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span><span class="o">.</span><span class="n">router_timeout_parameters</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span>
                <span class="n">placements</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_router_emergency_timeout</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span><span class="o">.</span><span class="n">router_emergency_timeout_parameters</span><span class="p">,</span>
                <span class="n">transceiver</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span>

            <span class="n">lead_monitor</span> <span class="o">=</span> <span class="n">extra_monitor_cores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lead_monitor</span><span class="o">.</span><span class="n">set_reinjection_packets</span><span class="p">(</span>
                <span class="n">placements</span><span class="p">,</span> <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span>
                <span class="n">point_to_point</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span><span class="o">.</span><span class="n">is_reinjecting_point_to_point</span><span class="p">,</span>
                <span class="n">multicast</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span><span class="o">.</span><span class="n">is_reinjecting_multicast</span><span class="p">,</span>
                <span class="n">nearest_neighbour</span><span class="o">=</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span><span class="o">.</span><span class="n">is_reinjecting_nearest_neighbour</span><span class="p">),</span>
                <span class="n">fixed_route</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span><span class="o">.</span><span class="n">is_reinjecting_fixed_route</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error resetting timeouts&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Checking if the cores are OK...&quot;</span><span class="p">)</span>
            <span class="n">core_subsets</span> <span class="o">=</span> <span class="n">convert_vertices_to_core_subset</span><span class="p">(</span>
                <span class="n">extra_monitor_cores</span><span class="p">,</span> <span class="n">placements</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">error_cores</span> <span class="o">=</span> <span class="n">transceiver</span><span class="o">.</span><span class="n">get_cores_not_in_state</span><span class="p">(</span>
                    <span class="n">core_subsets</span><span class="p">,</span> <span class="p">{</span><span class="n">CPUState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">error_cores</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cores in an unexpected state: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">error_cores</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get core state&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__reprogram_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make our tag deliver to the given connection.</span>

<span class="sd">        :param ~.SCAMPConnection connection: The connection to deliver to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">IPTagSet</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remote_tag</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_sender</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">get_scp_data</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">einfo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">receive_scp_response</span><span class="p">()</span>
                <span class="n">request</span><span class="o">.</span><span class="n">get_scp_response</span><span class="p">()</span><span class="o">.</span><span class="n">read_bytestring</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="n">SpinnmanTimeoutException</span><span class="p">:</span>
                <span class="n">einfo</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">einfo</span><span class="p">)</span>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.get_data"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">extra_monitor</span><span class="p">,</span> <span class="n">extra_monitor_placement</span><span class="p">,</span> <span class="n">memory_address</span><span class="p">,</span>
            <span class="n">length_in_bytes</span><span class="p">,</span> <span class="n">fixed_routes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets data from a given core and memory address.</span>

<span class="sd">        :param ExtraMonitorSupportMachineVertex extra_monitor:</span>
<span class="sd">            the extra monitor used for this data</span>
<span class="sd">        :param ~pacman.model.placements.Placement extra_monitor_placement:</span>
<span class="sd">            placement object for where to get data from</span>
<span class="sd">        :param int memory_address: the address in SDRAM to start reading from</span>
<span class="sd">        :param int length_in_bytes: the length of data to read in bytes</span>
<span class="sd">        :param fixed_routes: the fixed routes, used in the report of which\</span>
<span class="sd">            chips were used by the speed up process</span>
<span class="sd">        :type fixed_routes: dict(tuple(int,int),~spinn_machine.FixedRouteEntry)</span>
<span class="sd">        :return: byte array of the data</span>
<span class="sd">        :rtype: bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># if asked for no data, just return a empty byte array</span>
        <span class="k">if</span> <span class="n">length_in_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_data_items</span><span class="p">[</span>
                <span class="n">extra_monitor_placement</span><span class="p">,</span> <span class="n">memory_address</span><span class="p">,</span>
                <span class="n">length_in_bytes</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="n">transceiver</span> <span class="o">=</span> <span class="n">get_simulator</span><span class="p">()</span><span class="o">.</span><span class="n">transceiver</span>

        <span class="c1"># Update the IP Tag to work through a NAT firewall</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">SCAMPConnection</span><span class="p">(</span>
            <span class="n">chip_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">chip_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">remote_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reprogram_tag</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="c1"># update transaction id for extra monitor</span>
        <span class="n">extra_monitor</span><span class="o">.</span><span class="n">update_transaction_id</span><span class="p">()</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">extra_monitor</span><span class="o">.</span><span class="n">transaction_id</span>

        <span class="c1"># send</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">send_sdp_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__make_sdp_message</span><span class="p">(</span>
            <span class="n">extra_monitor_placement</span><span class="p">,</span>
            <span class="n">SDP_PORTS</span><span class="o">.</span><span class="n">EXTRA_MONITOR_CORE_DATA_SPEED_UP</span><span class="p">,</span>
            <span class="n">_FOUR_WORDS</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="n">DATA_OUT_COMMANDS</span><span class="o">.</span><span class="n">START_SENDING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">,</span>
                <span class="n">memory_address</span><span class="p">,</span> <span class="n">length_in_bytes</span><span class="p">)))</span>

        <span class="c1"># receive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">length_in_bytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_seq_num</span><span class="p">()</span>
        <span class="n">lost_seq_nums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_data</span><span class="p">(</span>
            <span class="n">transceiver</span><span class="p">,</span> <span class="n">extra_monitor_placement</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>

        <span class="c1"># Stop anything else getting through (and reduce traffic)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">send_sdp_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__make_sdp_message</span><span class="p">(</span>
            <span class="n">extra_monitor_placement</span><span class="p">,</span>
            <span class="n">SDP_PORTS</span><span class="o">.</span><span class="n">EXTRA_MONITOR_CORE_DATA_SPEED_UP</span><span class="p">,</span>
            <span class="n">_TWO_WORDS</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">DATA_OUT_COMMANDS</span><span class="o">.</span><span class="n">CLEAR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_data_items</span><span class="p">[</span>
            <span class="n">extra_monitor_placement</span><span class="p">,</span> <span class="n">memory_address</span><span class="p">,</span> <span class="n">length_in_bytes</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">lost_seq_nums</span><span class="p">))</span>

        <span class="c1"># create report elements</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_data_speed_up_reports</span><span class="p">:</span>
            <span class="n">routers_been_in_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_which_routers_were_used</span><span class="p">(</span>
                <span class="n">extra_monitor_placement</span><span class="p">,</span> <span class="n">fixed_routes</span><span class="p">,</span>
                <span class="n">transceiver</span><span class="o">.</span><span class="n">get_machine_details</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_routers_used_into_report</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out_report_path</span><span class="p">,</span> <span class="n">routers_been_in_use</span><span class="p">,</span>
                <span class="n">extra_monitor_placement</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span></div>

    <span class="k">def</span> <span class="nf">_receive_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placement</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param ~.Transceiver transceiver:</span>
<span class="sd">        :param ~.Placement placement:</span>
<span class="sd">        :param ~.UDPConnection connection:</span>
<span class="sd">        :param int transaction_id:</span>
<span class="sd">        :rtype: list(int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq_nums</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">lost_seq_nums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">timeoutcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_TIMEOUT_PER_RECEIVE_IN_SECONDS</span><span class="p">)</span>
                <span class="n">response_transaction_id</span><span class="p">,</span> <span class="o">=</span> <span class="n">_ONE_WORD</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">transaction_id</span> <span class="o">==</span> <span class="n">response_transaction_id</span><span class="p">:</span>
                    <span class="n">timeoutcount</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">seq_nums</span><span class="p">,</span> <span class="n">finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_data</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">seq_nums</span><span class="p">,</span> <span class="n">finished</span><span class="p">,</span> <span class="n">placement</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span>
                        <span class="n">lost_seq_nums</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;ignoring packet as transaction id should be </span><span class="si">{}</span><span class="s2">&quot;</span>
                        <span class="s2">&quot; but is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">transaction_id</span><span class="p">,</span> <span class="n">response_transaction_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">SpinnmanTimeoutException</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeoutcount</span> <span class="o">&gt;</span> <span class="n">TIMEOUT_RETRY_LIMIT</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SpinnFrontEndException</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to hear from the machine during </span><span class="si">{}</span><span class="s2"> attempts. &quot;</span>
                        <span class="s2">&quot;Please try removing firewalls&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timeoutcount</span><span class="p">))</span>

                <span class="n">timeoutcount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># self.__reset_connection()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
                    <span class="n">finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_and_retransmit_missing_seq_nums</span><span class="p">(</span>
                        <span class="n">seq_nums</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placement</span><span class="p">,</span> <span class="n">lost_seq_nums</span><span class="p">,</span>
                        <span class="n">transaction_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lost_seq_nums</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_determine_which_routers_were_used</span><span class="p">(</span><span class="n">placement</span><span class="p">,</span> <span class="n">fixed_routes</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Traverse the fixed route paths from a given location to its\</span>
<span class="sd">            destination. Used for determining which routers were used.</span>

<span class="sd">        :param ~.Placement placement: the source to start from</span>
<span class="sd">        :param dict(tuple(int,int),?) fixed_routes:</span>
<span class="sd">            the fixed routes for each router</span>
<span class="sd">        :param ~.Machine machine: the spinnMachine instance</span>
<span class="sd">        :return: list of chip locations</span>
<span class="sd">        :rtype: list(tuple(int,int))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">routers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">routers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">fixed_routes</span><span class="p">[(</span><span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">)]</span>
        <span class="n">chip_x</span> <span class="o">=</span> <span class="n">placement</span><span class="o">.</span><span class="n">x</span>
        <span class="n">chip_y</span> <span class="o">=</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">processor_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># can assume one link, as its a minimum spanning tree going to</span>
            <span class="c1"># the root</span>
            <span class="n">machine_link</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_chip_at</span><span class="p">(</span>
                <span class="n">chip_x</span><span class="p">,</span> <span class="n">chip_y</span><span class="p">)</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">link_ids</span><span class="p">)))</span>
            <span class="n">chip_x</span> <span class="o">=</span> <span class="n">machine_link</span><span class="o">.</span><span class="n">destination_x</span>
            <span class="n">chip_y</span> <span class="o">=</span> <span class="n">machine_link</span><span class="o">.</span><span class="n">destination_y</span>
            <span class="n">routers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chip_x</span><span class="p">,</span> <span class="n">chip_y</span><span class="p">))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">fixed_routes</span><span class="p">[(</span><span class="n">chip_x</span><span class="p">,</span> <span class="n">chip_y</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">routers</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_routers_used_into_report</span><span class="p">(</span>
            <span class="n">report_path</span><span class="p">,</span> <span class="n">routers_been_in_use</span><span class="p">,</span> <span class="n">placement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write the used routers into a report</span>

<span class="sd">        :param str report_path: the path to the report file</span>
<span class="sd">        :param list(tuple(int,int)) routers_been_in_use:</span>
<span class="sd">            the routers been in use</span>
<span class="sd">        :param ~.Placement placement: the first placement used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">writer_behaviour</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">report_path</span><span class="p">):</span>
            <span class="n">writer_behaviour</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="n">writer_behaviour</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">] = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">placement</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">placement</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">routers_been_in_use</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_calculate_missing_seq_nums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq_nums</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine which sequence numbers we&#39;ve missed</span>

<span class="sd">        :param set(int) seq_nums: the set already acquired</span>
<span class="sd">        :return: list of missing sequence numbers</span>
<span class="sd">        :rtype: list(int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">sn</span> <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seq_nums</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_determine_and_retransmit_missing_seq_nums</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">seq_nums</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span> <span class="n">placement</span><span class="p">,</span> <span class="n">lost_seq_nums</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine if there are any missing sequence numbers, and if so\</span>
<span class="sd">            retransmits the missing sequence numbers back to the core for\</span>
<span class="sd">            retransmission.</span>

<span class="sd">        :param set(int) seq_nums: the sequence numbers already received</span>
<span class="sd">        :param ~.Transceiver transceiver: spinnman instance</span>
<span class="sd">        :param ~.Placement placement: placement instance</span>
<span class="sd">        :param list(int) lost_seq_nums:</span>
<span class="sd">        :param int transaction_id: transaction_id</span>
<span class="sd">        :return: whether all packets are transmitted</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=too-many-locals</span>

        <span class="c1"># locate missing sequence numbers from pile</span>
        <span class="n">missing_seq_nums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_missing_seq_nums</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">)</span>

        <span class="n">lost_seq_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_seq_nums</span><span class="p">))</span>
        <span class="c1"># self._print_missing(missing_seq_nums)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_seq_nums</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># figure n packets given the 2 formats</span>
        <span class="n">n_packets</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">length_via_format2</span> <span class="o">=</span> \
            <span class="nb">len</span><span class="p">(</span><span class="n">missing_seq_nums</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">WORDS_PER_FULL_PACKET</span> <span class="o">-</span>
                <span class="n">WORDS_FOR_COMMAND_N_MISSING_TRANSACTION</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length_via_format2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n_packets</span> <span class="o">+=</span> <span class="n">ceildiv</span><span class="p">(</span>
                <span class="n">length_via_format2</span><span class="p">,</span>
                <span class="n">WORDS_PER_FULL_PACKET</span> <span class="o">-</span> <span class="n">WORDS_FOR_COMMAND_TRANSACTION</span><span class="p">)</span>
        <span class="c1"># self._print_missing_n_packets(n_packets)</span>

        <span class="c1"># transmit missing sequence as a new SDP packet</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">seq_num_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n_packets</span><span class="p">):</span>
            <span class="n">length_left_in_packet</span> <span class="o">=</span> <span class="n">WORDS_PER_FULL_PACKET</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># if first, add n packets to list</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>

                <span class="c1"># get left over space / data size</span>
                <span class="n">size_of_data_left_to_transmit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">length_left_in_packet</span> <span class="o">-</span>
                    <span class="n">WORDS_FOR_COMMAND_N_MISSING_TRANSACTION</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">missing_seq_nums</span><span class="p">)</span> <span class="o">-</span> <span class="n">seq_num_offset</span><span class="p">)</span>

                <span class="c1"># build data holder accordingly</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">size_of_data_left_to_transmit</span> <span class="o">+</span>
                     <span class="n">WORDS_FOR_COMMAND_N_MISSING_TRANSACTION</span><span class="p">)</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span>

                <span class="c1"># pack flag and n packets</span>
                <span class="n">_ONE_WORD</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">DATA_OUT_COMMANDS</span><span class="o">.</span><span class="n">START_MISSING_SEQ</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">_TWO_WORDS</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">BYTES_PER_WORD</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">,</span> <span class="n">n_packets</span><span class="p">)</span>

                <span class="c1"># update state</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">WORDS_FOR_COMMAND_N_MISSING_TRANSACTION</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span>
                <span class="n">length_left_in_packet</span> <span class="o">-=</span> <span class="p">(</span>
                    <span class="n">WORDS_FOR_COMMAND_N_MISSING_TRANSACTION</span><span class="p">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># just add data</span>
                <span class="c1"># get left over space / data size</span>
                <span class="n">size_of_data_left_to_transmit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">WORDS_PER_FULL_PACKET_WITH_SEQUENCE_NUM</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">missing_seq_nums</span><span class="p">)</span> <span class="o">-</span> <span class="n">seq_num_offset</span><span class="p">)</span>

                <span class="c1"># build data holder accordingly</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">size_of_data_left_to_transmit</span> <span class="o">+</span>
                     <span class="n">WORDS_FOR_COMMAND_TRANSACTION</span><span class="p">)</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span>

                <span class="c1"># pack flag</span>
                <span class="n">_TWO_WORDS</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                    <span class="n">DATA_OUT_COMMANDS</span><span class="o">.</span><span class="n">MISSING_SEQ</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="n">BYTES_PER_WORD</span> <span class="o">*</span> <span class="n">WORDS_FOR_COMMAND_TRANSACTION</span>
                <span class="n">length_left_in_packet</span> <span class="o">-=</span> <span class="n">WORDS_FOR_COMMAND_TRANSACTION</span>

            <span class="c1"># fill data field</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span>
                <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">I&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size_of_data_left_to_transmit</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                <span class="o">*</span><span class="n">missing_seq_nums</span><span class="p">[</span>
                    <span class="n">seq_num_offset</span><span class="p">:</span>
                    <span class="n">seq_num_offset</span> <span class="o">+</span> <span class="n">size_of_data_left_to_transmit</span><span class="p">])</span>
            <span class="n">seq_num_offset</span> <span class="o">+=</span> <span class="n">length_left_in_packet</span>

            <span class="c1"># build SDP message and send it to the core</span>
            <span class="n">transceiver</span><span class="o">.</span><span class="n">send_sdp_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__make_sdp_message</span><span class="p">(</span>
                <span class="n">placement</span><span class="p">,</span> <span class="n">SDP_PORTS</span><span class="o">.</span><span class="n">EXTRA_MONITOR_CORE_DATA_SPEED_UP</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

            <span class="c1"># sleep for ensuring core doesn&#39;t lose packets</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TIMEOUT_FOR_SENDING_IN_SECONDS</span><span class="p">)</span>
            <span class="c1"># self._print_packet_num_being_sent(packet_count, n_packets)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_process_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">seq_nums</span><span class="p">,</span> <span class="n">finished</span><span class="p">,</span> <span class="n">placement</span><span class="p">,</span> <span class="n">transceiver</span><span class="p">,</span>
            <span class="n">lost_seq_nums</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Take a packet and processes it see if we&#39;re finished yet.</span>

<span class="sd">        :param bytearray data: the packet data</span>
<span class="sd">        :param set(int) seq_nums: the list of sequence numbers received so far</span>
<span class="sd">        :param bool finished: bool which states if finished or not</span>
<span class="sd">        :param ~.Placement placement:</span>
<span class="sd">            placement object for location on machine</span>
<span class="sd">        :param ~.Transceiver transceiver: spinnman instance</span>
<span class="sd">        :param int transaction_id: the transaction id for this stream</span>
<span class="sd">        :param list(int) lost_seq_nums:</span>
<span class="sd">            the list of n sequence numbers lost per iteration</span>
<span class="sd">        :return: set of data items, if its the first packet, the list of</span>
<span class="sd">            sequence numbers, the sequence number received and if its finished</span>
<span class="sd">        :rtype: tuple(set(int), bool)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=too-many-arguments</span>
        <span class="c1"># self._print_out_packet_data(data)</span>
        <span class="n">length_of_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">first_packet_element</span><span class="p">,</span> <span class="o">=</span> <span class="n">_ONE_WORD</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># get flags</span>
        <span class="n">seq_num</span> <span class="o">=</span> <span class="n">first_packet_element</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SEQUENCE_NUMBER_MASK</span>
        <span class="n">is_end_of_stream</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">first_packet_element</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LAST_MESSAGE_FLAG_BIT_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># check seq num not insane</span>
        <span class="k">if</span> <span class="n">seq_num</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;got an insane sequence number. got </span><span class="si">{}</span><span class="s2"> when &quot;</span>
                <span class="s2">&quot;the max is </span><span class="si">{}</span><span class="s2"> with a length of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">seq_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span><span class="p">,</span> <span class="n">length_of_data</span><span class="p">))</span>

        <span class="c1"># figure offset for where data is to be put</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_offset</span><span class="p">(</span><span class="n">seq_num</span><span class="p">)</span>

        <span class="c1"># write data</span>

        <span class="c1"># read offset from data is at byte 8. as first 4 is seq num,</span>
        <span class="c1"># second 4 is transaction id</span>
        <span class="n">true_data_length</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">offset</span> <span class="o">+</span> <span class="n">length_of_data</span> <span class="o">-</span> <span class="n">BYTES_FOR_SEQ_AND_TRANSACTION_ID</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_end_of_stream</span> <span class="ow">or</span>
                <span class="n">length_of_data</span> <span class="o">!=</span> <span class="n">BYTES_FOR_SEQ_AND_TRANSACTION_ID</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_into_view</span><span class="p">(</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">true_data_length</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                <span class="n">BYTES_FOR_SEQ_AND_TRANSACTION_ID</span><span class="p">,</span> <span class="n">length_of_data</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span>
                <span class="n">length_of_data</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># add seq num to list</span>
        <span class="n">seq_nums</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">seq_num</span><span class="p">)</span>

        <span class="c1"># if received a last flag on its own, its during retransmission.</span>
        <span class="c1">#  check and try again if required</span>
        <span class="k">if</span> <span class="n">is_end_of_stream</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">):</span>
                <span class="n">finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_and_retransmit_missing_seq_nums</span><span class="p">(</span>
                    <span class="n">placement</span><span class="o">=</span><span class="n">placement</span><span class="p">,</span> <span class="n">transceiver</span><span class="o">=</span><span class="n">transceiver</span><span class="p">,</span>
                    <span class="n">seq_nums</span><span class="o">=</span><span class="n">seq_nums</span><span class="p">,</span> <span class="n">lost_seq_nums</span><span class="o">=</span><span class="n">lost_seq_nums</span><span class="p">,</span>
                    <span class="n">transaction_id</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">seq_nums</span><span class="p">,</span> <span class="n">finished</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_offset</span><span class="p">(</span><span class="n">seq_num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param int seq_num:</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">seq_num</span> <span class="o">*</span> <span class="n">WORDS_PER_FULL_PACKET_WITH_SEQUENCE_NUM</span> <span class="o">*</span>
                <span class="n">BYTES_PER_WORD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_into_view</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">view_start_position</span><span class="p">,</span> <span class="n">view_end_position</span><span class="p">,</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">data_start_position</span><span class="p">,</span> <span class="n">data_end_position</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span>
            <span class="n">packet_length</span><span class="p">,</span> <span class="n">is_final</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Puts data into the view</span>

<span class="sd">        :param int view_start_position: where in view to start</span>
<span class="sd">        :param int view_end_position: where in view to end</span>
<span class="sd">        :param bytearray data: the data holder to write from</span>
<span class="sd">        :param int data_start_position: where in data holder to start from</span>
<span class="sd">        :param int data_end_position: where in data holder to end</span>
<span class="sd">        :param int seq_num: the sequence number to figure</span>
<span class="sd">        :raises Exception: If the position to write to is crazy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=too-many-arguments</span>
        <span class="k">if</span> <span class="n">view_end_position</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;I&#39;m trying to add to my output data, but am trying to add &quot;</span>
                <span class="s2">&quot;outside my acceptable output positions! max is </span><span class="si">{}</span><span class="s2"> and I &quot;</span>
                <span class="s2">&quot;received a request to fill to </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2"> for sequence num &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> from max sequence num </span><span class="si">{}</span><span class="s2"> length of packet </span><span class="si">{}</span><span class="s2"> and &quot;</span>
                <span class="s2">&quot;final </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">),</span> <span class="n">view_end_position</span><span class="p">,</span> <span class="n">view_start_position</span><span class="p">,</span>
                    <span class="n">seq_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet_length</span><span class="p">,</span> <span class="n">is_final</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="p">[</span><span class="n">view_start_position</span><span class="p">:</span> <span class="n">view_end_position</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">data</span><span class="p">[</span><span class="n">data_start_position</span><span class="p">:</span><span class="n">data_end_position</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq_nums</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verify if the sequence numbers are correct.</span>

<span class="sd">        :param list(int) seq_nums: the received sequence numbers</span>
<span class="sd">        :return: Whether all the sequence numbers have been received</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># hand back</span>
        <span class="n">seq_nums</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">)</span>
        <span class="n">max_needed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_seq_num</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_needed</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;I&#39;ve received more data than I was expecting!!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_needed</span> <span class="o">+</span> <span class="mi">1</span>

<div class="viewcode-block" id="DataSpeedUpPacketGatherMachineVertex.calculate_max_seq_num"><a class="viewcode-back" href="../../../spinn_front_end_common.utility_models.html#spinn_front_end_common.utility_models.DataSpeedUpPacketGatherMachineVertex.calculate_max_seq_num">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_max_seq_num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deduce the max sequence number expected to be received</span>

<span class="sd">        :return: the biggest sequence num expected</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ceildiv</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">),</span>
            <span class="n">WORDS_PER_FULL_PACKET_WITH_SEQUENCE_NUM</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_print_missing</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Debug printer for the missing sequence numbers from the pile.</span>

<span class="sd">        :param list(int) seq_nums: the sequence numbers received so far</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seq_num</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;from list I&#39;m missing sequence num </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_print_missing_n_packets</span><span class="p">(</span><span class="n">n_packets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Debug printer for the number of missing packets from the pile.</span>

<span class="sd">        :param n_packets: the number of packets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;missing packets = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">n_packets</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_print_out_packet_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Debug prints out the data from the packet.</span>

<span class="sd">        :param bytearray data: the packet data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reread_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">B&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">position2</span> <span class="o">=</span> <span class="n">position</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;size of data is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">reread_data_element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reread_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">position2</span><span class="p">,</span> <span class="n">reread_data_element</span><span class="p">)</span>
                <span class="n">position2</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;converted data back into readable form is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_print_length_of_received_seq_nums</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">,</span> <span class="n">max_needed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Debug helper method for figuring out if everything been received.</span>

<span class="sd">        :param int seq_nums: sequence numbers received</span>
<span class="sd">        :param int max_needed: biggest expected to have</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">)</span> <span class="o">!=</span> <span class="n">max_needed</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;should have received </span><span class="si">{}</span><span class="s2"> sequence numbers, but received &quot;</span>
                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> sequence numbers&quot;</span><span class="p">,</span> <span class="n">max_needed</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_nums</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_print_packet_num_being_sent</span><span class="p">(</span><span class="n">packet_count</span><span class="p">,</span> <span class="n">n_packets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Debug helper for printing missing sequence number packet\</span>
<span class="sd">            transmission.</span>

<span class="sd">        :param int packet_count: which packet is being fired</span>
<span class="sd">        :param int n_packets: how many packets to fire.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;send SDP packet with missing sequence numbers: </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
                  <span class="n">packet_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_packets</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_StreamingContextManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The implementation of the context manager object for streaming \</span>
<span class="sd">        configuration control.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_gatherers&quot;</span><span class="p">,</span> <span class="s2">&quot;_monitors&quot;</span><span class="p">,</span> <span class="s2">&quot;_placements&quot;</span><span class="p">,</span> <span class="s2">&quot;_txrx&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gatherers</span><span class="p">,</span> <span class="n">txrx</span><span class="p">,</span> <span class="n">monitors</span><span class="p">,</span> <span class="n">placements</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gatherers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gatherers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_txrx</span> <span class="o">=</span> <span class="n">txrx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span> <span class="o">=</span> <span class="n">monitors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placements</span> <span class="o">=</span> <span class="n">placements</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">gatherer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gatherers</span><span class="p">:</span>
            <span class="n">gatherer</span><span class="o">.</span><span class="n">load_system_routing_tables</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_txrx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placements</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gatherer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gatherers</span><span class="p">:</span>
            <span class="n">gatherer</span><span class="o">.</span><span class="n">set_cores_for_data_streaming</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_txrx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placements</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_type</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">_tb</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">gatherer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gatherers</span><span class="p">:</span>
            <span class="n">gatherer</span><span class="o">.</span><span class="n">unset_cores_for_data_streaming</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_txrx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placements</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gatherer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gatherers</span><span class="p">:</span>
            <span class="n">gatherer</span><span class="o">.</span><span class="n">load_application_routing_tables</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_txrx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placements</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SpiNNFrontEndCommon  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014-2017.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>